name: Deploy
 
on:
  # Enable manual deploys from the GitHub UI
  workflow_dispatch:
  # Enable automatic deploys whenever code is pushed to the dev or main branches
  push:
    branches:
      - dev
      - main
 
jobs:
  build-and-deploy:
    runs-on: windows-latest
    steps:
      # Checkout your Git repo
      - uses: actions/checkout@v4
      # Install foreman and all foreman tools (rojo and mantle)
      - uses: Roblox/setup-foreman@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm install
        run: npm install

      - name: Compile Project
        run: npm run build

      # Build the project with rojo
      - name: Build project
        run: rojo build --output codebaseGame.rbxlx

      #combines the current uploaded game with the built project with rojo
      - name: Merge project
        run: lune run updatePlace
        env: 
          ROBLOSECURITY: ${{ secrets.ROBLOSECURITY }}
          PLACEID: ${{ secrets.PLACEID }}

      - name: Import project
        run: mantle import --target-id $UniverseId
        env:
          UniverseId: ${{ secrets.UniverseId }}

      # Deploy the project with mantle
      - name: Deploy project
        run: mantle deploy
        env:
          ROBLOSECURITY: ${{ secrets.ROBLOSECURITY }}
          MANTLE_OPEN_CLOUD_API_KEY: ${{ secrets.MANTLE_OPEN_CLOUD_API_KEY }}